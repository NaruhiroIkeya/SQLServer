PRINT '---Backup All System Databases---'
DECLARE @BACKUP_URL VARCHAR(128) = $(S3bucket)

DECLARE @StringDate CHAR(12) = FORMAT(GETDATE(),'yyyyMMddHHmm');
DECLARE @HOSTNAME VARCHAR(64) = @@SERVERNAME;
DECLARE @EXEC_SQL VARCHAR(MAX);
DECLARE @STARTDATE datetime;
DECLARE @FINISHDATE datetime;

SET @EXEC_SQL = 'USE [?]; IF DB_ID() IN (1, 4, 3) BEGIN BACKUP DATABASE [?] TO URL = ''' + @BACKUP_URL + @HOSTNAME + '_' + '?_FULL_' + @StringDate + '.bak'' END'

PRINT '---START DATE & TIME---'
PRINT CONVERT(varchar,@STARTDATE,121);
EXEC sys.sp_MSforeachdb @EXEC_SQL
IF @@ERROR = 0
  BEGIN
    PRINT 'return status = 0'
  END
ELSE
  BEGIN
    PRINT 'return status = 1'
  END
SET @FINISHDATE = GETDATE();
PRINT '---FINISH DATE & TIME---'
PRINT CONVERT(varchar,@FINISHDATE,121);
PRINT '---ELAPSED TIME---'
PRINT CONVERT(CHAR(12), DATEADD(SECOND, DATEDIFF(SECOND, @STARTDATE, @FINISHDATE), CONVERT(DATETIME, 0)), 108)
